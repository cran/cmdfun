<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>Writing shell wrappers with cmdfun</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Writing shell wrappers with cmdfun</h1>



<div id="a-simple-framework-for-building-shell-interfaces" class="section level2">
<h2>A simple framework for building shell interfaces</h2>
<p>The purpose of <code>cmdfun</code> is to significantly reduce the overhead involved in wrapping shell programs in R. The tools are intended to be intuitive and lightweight enough to use for data scientists trying to get things done quickly, but robust and full-fledged enough for developers to extend them to more advanced use cases.</p>
<p>Briefly, <code>cmdfun</code> captures R function arguments (<strong>args</strong>) as a base R <code>list</code> and converts them to a vector of commandline <strong>flags</strong>.</p>
</div>
<div id="grabbing-function-arguments-as-lists" class="section level2">
<h2>Grabbing function arguments as lists</h2>
<p>The <code>cmdfun</code> framework provides three mechanisms for capturing function arguments:</p>
<ul>
<li><code>cmd_args_dots()</code> captures all arguments passed to <code>...</code></li>
<li><code>cmd_args_named()</code> captures all keyword arguments defined by the user</li>
<li><code>cmd_args_all()</code> captures both named + dot arguments</li>
</ul>
<p><code>cmd_list_interp</code> converts the captured argument list to a parsed list of flag/value pairs (details below). This output can be useful for additional handling of special flag assignments from within R.</p>
<p><code>cmd_list_to_flags</code> converts a list to a vector of commandline-style flags using the list names as flag names and the list values as the flag values (empty values return only the flag). This output can be directly fed to <code>system2</code> or <code>processx</code>.</p>
<p>Together, they can be used to build user-friendly R interfaces to shell programs without having to manually implement all commandline flags in R functions.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(magrittr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(cmdfun)</a></code></pre></div>
<p>The <code>cmd_args</code> family of functions operate <strong>within</strong> a function environment to capture the arguments. Therefore, to examine their behavior, they must be wrapped in functions.</p>
<p>Here I’ll compare the differences between the three <code>cmd_args</code> functions.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">get_all &lt;-<span class="st"> </span><span class="cf">function</span>(arg1, arg2, ...){</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="kw">cmd_args_all</span>()</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">get_named &lt;-<span class="st"> </span><span class="cf">function</span>(arg1, arg2, ...){</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="kw">cmd_args_named</span>()</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">get_dots &lt;-<span class="st"> </span><span class="cf">function</span>(arg1, arg2, ...){</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">  <span class="kw">cmd_args_dots</span>()</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">}</a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># cmd_args_all() gets all keword arguments and arguments passed to &quot;...&quot;</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">(argsListAll &lt;-<span class="st"> </span><span class="kw">get_all</span>(<span class="st">&quot;input&quot;</span>, <span class="ot">NA</span>, <span class="dt">bool =</span> <span class="ot">TRUE</span>, <span class="dt">vals =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)))</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#&gt; $arg1</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; [1] &quot;input&quot;</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; $arg2</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; [1] NA</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt; $bool</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt; $vals</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#&gt; [1] 1 2 3</span></a></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># cmd_args_named() gets all keword arguments, excluding arguments passed to &quot;...&quot;</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">(argsListNamed &lt;-<span class="st"> </span><span class="kw">get_named</span>(<span class="st">&quot;input&quot;</span>, <span class="ot">NA</span>, <span class="dt">bool =</span> <span class="ot">TRUE</span>, <span class="dt">vals =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)))</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">#&gt; $arg1</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; [1] &quot;input&quot;</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#&gt; $arg2</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#&gt; [1] NA</span></a></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># cmd_args_dots() gets all arguments passed to &quot;...&quot;, excluding keyword arguments</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">(argsListDots &lt;-<span class="st"> </span><span class="kw">get_dots</span>(<span class="st">&quot;input&quot;</span>, <span class="ot">NA</span>, <span class="dt">bool =</span> <span class="ot">TRUE</span>, <span class="dt">vals =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)))</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt; $bool</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt; [1] TRUE</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co">#&gt; $vals</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co">#&gt; [1] 1 2 3</span></a></code></pre></div>
<p>The captured argument lists contain the argument names as list names, and the argument values as list values.</p>
</div>
<div id="create-r-representations-of-commandline-flags" class="section level2">
<h2>Create R representations of commandline flags</h2>
<p>Passing flags to commandline software inherently varies from how arguments are passed to R functions. For example, some flags require values to follow them, while others do not (ie <code>head -n 5</code> vs <code>ls -l</code>). In some cases, flags can have multiple values assigned to them, passed as comma-separated entries (ie <code>cut -f 1,2,3</code>).</p>
<p>To facilitate the conversion of these concepts between R and the shell, <code>cmd_list_interp</code> <strong>interprets</strong> R data structures in each list entry and converts them where necessary to prepare them for final conversion to a character vector.</p>
<p>Argument values are interpreted according to the following rules:</p>
<table>
<thead>
<tr class="header">
<th align="center">Argument Value Type</th>
<th align="center"><code>cmd_list_interp</code> behavior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>character(1)</code></td>
<td align="center">keep</td>
</tr>
<tr class="even">
<td align="center"><code>numeric(1)</code></td>
<td align="center">keep</td>
</tr>
<tr class="odd">
<td align="center"><code>character</code> vector</td>
<td align="center">keep</td>
</tr>
<tr class="even">
<td align="center"><code>numeric</code> vector</td>
<td align="center">keep</td>
</tr>
<tr class="odd">
<td align="center"><code>factor</code></td>
<td align="center">keep</td>
</tr>
<tr class="even">
<td align="center"><code>TRUE</code></td>
<td align="center">Convert to: &quot;&quot;</td>
</tr>
<tr class="odd">
<td align="center"><code>FALSE</code></td>
<td align="center">Drop entry from list</td>
</tr>
<tr class="even">
<td align="center"><code>NA</code></td>
<td align="center">Drop entry from list</td>
</tr>
<tr class="odd">
<td align="center"><code>NULL</code></td>
<td align="center">Drop entry from list</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># Note that `arg2` is dropped, and `bool` is converted to &quot;&quot;</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw">cmd_list_interp</span>(argsListAll) </a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#&gt; $arg1</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#&gt; [1] &quot;input&quot;</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt; $bool</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt; [1] &quot;&quot;</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co">#&gt; $vals</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="co">#&gt; [1] 1 2 3</span></a></code></pre></div>
<p>Commandline tools can have hundreds of arguments, many with uninformative, often single-letter, names. To prevent developers from having to write aliased function arguments for all, often conflicting flags, <code>cmd_list_interp</code> can additionally use a lookup table to allow developers to provide informative function argument names for unintuitive flags.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">(flagList &lt;-<span class="st"> </span><span class="kw">cmd_list_interp</span>(argsListAll, <span class="kw">c</span>(<span class="st">&quot;bool&quot;</span> =<span class="st"> &quot;b&quot;</span>)))</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt; $arg1</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt; [1] &quot;input&quot;</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt; $b</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt; [1] &quot;&quot;</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co">#&gt; $vals</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt; [1] 1 2 3</span></a></code></pre></div>
</div>
<div id="convert-lists-to-flag-vectors" class="section level2">
<h2>Convert lists to flag vectors</h2>
<p>After interpreting argument lists with <code>cmd_list_interp</code>, the resulting list can be coerced into a vector suitable for passing to <code>system2</code> or <code>processx</code> using <code>cmd_list_to_flags</code>. <code>cmd_list_to_flags</code> will produce the following vector values for each name/value pair in the list:</p>
<table>
<thead>
<tr class="header">
<th align="center">Argument Value Type</th>
<th align="center"><code>cmd_list_to_flags</code> behavior</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center"><code>character(1)</code></td>
<td align="center"><code>c(&quot;-name&quot;, &quot;value&quot;)</code></td>
</tr>
<tr class="even">
<td align="center"><code>numeric(1)</code></td>
<td align="center"><code>c(&quot;-name&quot;, &quot;value&quot;)</code></td>
</tr>
<tr class="odd">
<td align="center"><code>character</code> vector</td>
<td align="center"><code>c(&quot;-name&quot;, &quot;a,b,c&quot;)</code></td>
</tr>
<tr class="even">
<td align="center"><code>numeric</code> vector</td>
<td align="center"><code>c(&quot;-name&quot;, &quot;1,2,3&quot;)</code></td>
</tr>
<tr class="odd">
<td align="center"><code>factor</code></td>
<td align="center">same as <code>character</code></td>
</tr>
<tr class="even">
<td align="center">empty string: &quot;&quot;</td>
<td align="center"><code>c(&quot;-name&quot;)</code></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">cmd_list_to_flags</span>(flagList)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co">#&gt; [1] &quot;-arg1&quot; &quot;input&quot; &quot;-b&quot;    &quot;-vals&quot; &quot;1,2,3&quot;</span></a></code></pre></div>
</div>
<div id="examples-using-unix-tools" class="section level2">
<h2>Examples using unix tools</h2>
<p>Here are two examples wrapping common shell utilities <code>ls</code> and <code>cut</code>.</p>
<div id="wrapping-ls-with-cmdfun" class="section level3">
<h3>Wrapping <code>ls</code> with cmdfun</h3>
<p>These tools can be used to easily wrap <code>ls</code>, a command which lists files in the target directory.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">library</span>(magrittr)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">shell_ls &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">dir =</span> <span class="st">&quot;.&quot;</span>, ...){</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  <span class="co"># grab arguments passed to &quot;...&quot; in a list</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">  flags &lt;-<span class="st"> </span><span class="kw">cmd_args_dots</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="st">    </span><span class="co"># prepare list for conversion to vector</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="st">    </span><span class="kw">cmd_list_interp</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="st">    </span><span class="co"># Convert the list to a flag vector</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="st">    </span><span class="kw">cmd_list_to_flags</span>()</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb9-11" data-line-number="11">  <span class="co"># Run ls shell command</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12">  <span class="kw">system2</span>(<span class="st">&quot;ls&quot;</span>, <span class="kw">c</span>(flags, dir), <span class="dt">stdout =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">}</a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># list all .md files in ../</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw">shell_ls</span>(<span class="st">&quot;../*.md&quot;</span>)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co">#&gt; [1] &quot;../LICENSE.md&quot;       &quot;../NEWS.md&quot;          &quot;../README.md&quot;       </span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">#&gt; [4] &quot;../cran-comments.md&quot;</span></a></code></pre></div>
<div id="boolean-flags-are-passed-as-bool-operators" class="section level4">
<h4>Boolean flags are passed as bool operators</h4>
<p><code>ls -l</code> can be mimiced by passing <code>l = TRUE</code> to ‘…’.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">shell_ls</span>(<span class="st">&quot;../*.md&quot;</span>, <span class="dt">l =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#&gt; [1] &quot;-rw-r--r-- 1 snystrom its_employee_psx 1077 Aug 20 19:20 ../LICENSE.md&quot;      </span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co">#&gt; [2] &quot;-rw-r--r-- 1 snystrom its_employee_psx  837 Aug 26 21:51 ../NEWS.md&quot;         </span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co">#&gt; [3] &quot;-rw-r--r-- 1 snystrom its_employee_psx 8192 Aug 26 21:51 ../README.md&quot;       </span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">#&gt; [4] &quot;-rw-r--r-- 1 snystrom its_employee_psx  965 Aug 26 22:29 ../cran-comments.md&quot;</span></a></code></pre></div>
</div>
<div id="using-a-lookup-table-to-make-user-friendly-argument-names" class="section level4">
<h4>Using a lookup table to make user-friendly argument names</h4>
<p>For example, allowing <code>long</code> to act as <code>-l</code> in <code>ls</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">shell_ls_alias &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">dir =</span> <span class="st">&quot;.&quot;</span>, ...){</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb12-4" data-line-number="4">  <span class="co"># Named vector acts as lookup table</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">  <span class="co"># name = function argument</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6">  <span class="co"># value = flag name</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">  names_arg_to_flag &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;long&quot;</span> =<span class="st"> &quot;l&quot;</span>)</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb12-9" data-line-number="9">  flags &lt;-<span class="st"> </span><span class="kw">cmd_args_dots</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="st">    </span><span class="co"># Use lookup table to manage renames</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="st">    </span><span class="kw">cmd_list_interp</span>(names_arg_to_flag) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="st">    </span><span class="kw">cmd_list_to_flags</span>()</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">  </a>
<a class="sourceLine" id="cb12-14" data-line-number="14">  <span class="kw">system2</span>(<span class="st">&quot;ls&quot;</span>, <span class="kw">c</span>(flags, dir), <span class="dt">stdout =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-15" data-line-number="15">}</a></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">shell_ls_alias</span>(<span class="st">&quot;../*.md&quot;</span>, <span class="dt">long =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co">#&gt; [1] &quot;-rw-r--r-- 1 snystrom its_employee_psx 1077 Aug 20 19:20 ../LICENSE.md&quot;      </span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">#&gt; [2] &quot;-rw-r--r-- 1 snystrom its_employee_psx  837 Aug 26 21:51 ../NEWS.md&quot;         </span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; [3] &quot;-rw-r--r-- 1 snystrom its_employee_psx 8192 Aug 26 21:51 ../README.md&quot;       </span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#&gt; [4] &quot;-rw-r--r-- 1 snystrom its_employee_psx  965 Aug 26 22:29 ../cran-comments.md&quot;</span></a></code></pre></div>
</div>
</div>
<div id="wrapping-cut-with-cmdfun" class="section level3">
<h3>Wrapping <code>cut</code> with cmdfun</h3>
<p>Here is another example wrapping <code>cut</code> which separates text on a delimiter (set with <code>-d</code>) and returns selected fields (set with <code>-f</code>) from the separation. Again, we use a lookup table to create the optional <code>sep</code> and <code>fields</code> arguments which specify <code>-d</code> and <code>-f</code>, respectively.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">shell_cut &lt;-<span class="st"> </span><span class="cf">function</span>(text, ...){</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  names_arg_to_flag &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;sep&quot;</span> =<span class="st"> &quot;d&quot;</span>,</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">                         <span class="st">&quot;fields&quot;</span> =<span class="st"> &quot;f&quot;</span>)</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">    </a>
<a class="sourceLine" id="cb14-6" data-line-number="6">    flags &lt;-<span class="st"> </span><span class="kw">cmd_args_dots</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="st">        </span><span class="kw">cmd_list_interp</span>(names_arg_to_flag) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="st">      </span><span class="kw">cmd_list_to_flags</span>()</a>
<a class="sourceLine" id="cb14-9" data-line-number="9"></a>
<a class="sourceLine" id="cb14-10" data-line-number="10">    <span class="kw">system2</span>(<span class="st">&quot;cut&quot;</span>, flags, <span class="dt">stdout =</span> T, <span class="dt">input =</span> text)</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">}</a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">shell_cut</span>(<span class="st">&quot;hello_world&quot;</span>, <span class="dt">fields =</span> <span class="dv">2</span>, <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>) </a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="co">#&gt; [1] &quot;world&quot;</span></a></code></pre></div>
<p>Multiple values can be passed to arguments using vectors</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># Note that the flag name values are accepted even when using a lookup table</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="kw">shell_cut</span>(<span class="st">&quot;hello_world_hello&quot;</span>, <span class="dt">f =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="dt">d =</span> <span class="st">&quot;_&quot;</span>) </a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co">#&gt; [1] &quot;hello_hello&quot;</span></a></code></pre></div>
</div>
</div>
<div id="abstraction-of-command-path-detection" class="section level2">
<h2>Abstraction of command path detection</h2>
<p>Command executables can be stored in different locations across devices, therefore another barrier to wrapping external software is detecting the location of the desired tool. The simplest solution is to ask the user to provide the location to their install, however, requiring this for every function call can become repetitive and clunky. To reduce this cognitive overhead, a common pattern when designing shell interfaces is to ask the user to pass this information to R by using either R environment variables defined in <code>.Renviron</code>, using options (set with <code>options()</code>, and got with <code>getOption()</code>). Fallback options can include having the user explicitly pass the path each time in the function call, or failing this, using a default install path.</p>
<p><code>cmd_path_search()</code> is a macro which returns a function that returns a valid path to the target by hierarchically searching a series of possible locations according to the following hierarchy:</p>
<ol style="list-style-type: decimal">
<li>Manually passing the install path to the function call</li>
<li>An option set using <code>options(option_name = &quot;value&quot;)</code></li>
<li>An environment variable set in <code>.Renviron</code></li>
<li>A default install location</li>
</ol>
<p>The resulting search function will always prefer the most specific option (ie when a user explicitly passes a path) before falling back to a less-specific assignment. It is up to the designer whether to support any or all of these features.</p>
<p>For example, to build an interface to the “MEME” suite, which is by default installed to <code>~/meme/bin</code>, one could build the following:</p>
<p>This will search for <code>~/meme/bin</code> and either return a valid path if it exists, or throw an error if it can’t be found.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">search_meme_path &lt;-<span class="st"> </span><span class="kw">cmd_path_search</span>(<span class="dt">default_path =</span> <span class="st">&quot;~/meme/bin&quot;</span>)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="kw">search_meme_path</span>()</a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="co">#&gt; [1] &quot;/nas/longleaf/home/snystrom/meme/bin&quot;</span></a></code></pre></div>
<p>The user can always pass their own path which will override the default location. If this path is invalid, the search function will error.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">search_meme_path</span>(<span class="st">&quot;bad/path&quot;</span>)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="co">#&gt; Error in .check_valid_command_path(path): Command: bad/path, does not exist.</span></a></code></pre></div>
<p>To instead only search the R environment variable “MEME_PATH”, one could build:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">search_meme_path &lt;-<span class="st"> </span><span class="kw">cmd_path_search</span>(<span class="dt">environment_var =</span> <span class="st">&quot;MEME_PATH&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="co"># Without environment variable defined</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="kw">search_meme_path</span>()</a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="co">#&gt; Error in search_meme_path(): No path defined or detected</span></a></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="co"># With environment variable defined</span></a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="kw">Sys.setenv</span>(<span class="st">&quot;MEME_PATH&quot;</span> =<span class="st"> &quot;~/meme/bin&quot;</span>)</a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="kw">search_meme_path</span>()</a>
<a class="sourceLine" id="cb21-4" data-line-number="4"><span class="co">#&gt; [1] &quot;/nas/longleaf/home/snystrom/meme/bin&quot;</span></a></code></pre></div>
<p>Multiple arguments can be used, and they will be searched from most-specific, to most-general.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">search_meme_path &lt;-<span class="st"> </span><span class="kw">cmd_path_search</span>(<span class="dt">environment_var =</span> <span class="st">&quot;MEME_PATH&quot;</span>,</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">                                       <span class="dt">default_path =</span> <span class="st">&quot;~/meme/bin&quot;</span>)</a></code></pre></div>
<p>For example, if “MEME_PATH” is invalid on my machine, the search_function will return the default path as long as the default is also valid on my machine.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">Sys.setenv</span>(<span class="st">&quot;MEME_PATH&quot;</span> =<span class="st"> &quot;bad/path&quot;</span>)</a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="kw">search_meme_path</span>()</a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="co">#&gt; [1] &quot;/nas/longleaf/home/snystrom/meme/bin&quot;</span></a></code></pre></div>
<p>As always, if the user passes their own path, this will take precedence.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw">search_meme_path</span>(<span class="dt">path =</span> <span class="st">&quot;bad/path&quot;</span>)</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="co">#&gt; Error in .check_valid_command_path(path): Command: bad/path, does not exist.</span></a></code></pre></div>
<div id="support-for-tool-utilities" class="section level3">
<h3>Support for tool utilities</h3>
<p>Some software, like the MEME suite is distributed as several binaries located in a common directory. To allow interface builders to officially support specific binaries, each binary can be defined as a “utility” within the build path.</p>
<p>Here, I will include two tools from the MEME suite, AME, and DREME (distributed as binaries named “ame”, and “dreme”). The user can set the binary location by setting the <code>MEME_PATH</code> environment variable, passing their own path, or fall back to the default install location.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">search_meme_path &lt;-<span class="st"> </span><span class="kw">cmd_path_search</span>(<span class="dt">environment_var =</span> <span class="st">&quot;MEME_PATH&quot;</span>,</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">                                       <span class="dt">default_path =</span> <span class="st">&quot;~/meme/bin&quot;</span>,</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">                                       <span class="dt">utils =</span> <span class="kw">c</span>(<span class="st">&quot;dreme&quot;</span>, <span class="st">&quot;ame&quot;</span>))</a></code></pre></div>
<p>search_function functions have two optional arguments: <code>path</code> and <code>util</code>. <code>path</code> acts as an override to the defaults provided when building the search_function. User-provided path variables will always be used instead of provided defaults. This is to catch problems from the user and not cause unexpected user-level behavior.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw">search_meme_path</span>(<span class="st">&quot;bad/path&quot;</span>)</a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="co">#&gt; Error in .check_valid_command_path(path): Command: bad/path, does not exist.</span></a></code></pre></div>
<p><code>util</code> specifies which utility path to return (if any). The path search_function will throw an error if the utility is not found in any of the specified locations.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">search_meme_path</span>(<span class="dt">util =</span> <span class="st">&quot;dreme&quot;</span>)</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="co">#&gt; [1] &quot;/nas/longleaf/home/snystrom/meme/bin/dreme&quot;</span></a></code></pre></div>
<p>The <code>cmd_install_check</code> function can be lightly wrapped by package builders to verify and print a user-friendly series of checks for a valid tool install. it takes as input the output of <code>cmd_path_search</code> and an optional user-override <code>path</code>. The search logic is inherited from the path search function, so the options and environment variables are also searched.</p>
<p>Here I build a function for checking a users <code>meme</code> install.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">check_meme_install &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">path =</span> <span class="ot">NULL</span>){</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">  <span class="kw">cmd_install_check</span>(search_meme_path, <span class="dt">path =</span> path)</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">}</a></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="co"># searches default meme search locations</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="kw">check_meme_install</span>()</a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="co">#&gt; checking main install</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4"><span class="co">#&gt; ✓ /nas/longleaf/home/snystrom/meme/bin</span></a>
<a class="sourceLine" id="cb29-5" data-line-number="5"><span class="co">#&gt; checking util installs</span></a>
<a class="sourceLine" id="cb29-6" data-line-number="6"><span class="co">#&gt; ✓ /nas/longleaf/home/snystrom/meme/bin/dreme</span></a>
<a class="sourceLine" id="cb29-7" data-line-number="7"><span class="co">#&gt; ✓ /nas/longleaf/home/snystrom/meme/bin/ame</span></a></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="co"># uses user override</span></a>
<a class="sourceLine" id="cb30-2" data-line-number="2"><span class="kw">check_meme_install</span>(<span class="st">'bad/path'</span>)</a>
<a class="sourceLine" id="cb30-3" data-line-number="3"><span class="co">#&gt; checking main install</span></a>
<a class="sourceLine" id="cb30-4" data-line-number="4"><span class="co">#&gt; x bad/path</span></a></code></pre></div>
<p>If you want to write your own install checker instead of using the <code>cmd_install_check</code> function, <code>cmdfun</code> also provides the <code>cmd_ui_file_exists</code> function for printing pretty status messages.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw">cmd_ui_file_exists</span>(<span class="st">&quot;bad/file&quot;</span>)</a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="co">#&gt; x bad/file</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="kw">cmd_ui_file_exists</span>(<span class="st">&quot;~/meme/bin&quot;</span>)</a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="co">#&gt; ✓ ~/meme/bin</span></a></code></pre></div>
</div>
<div id="internal-install-validators" class="section level3">
<h3>Internal install validators</h3>
<p><code>cmdfun</code> also provides a macro <code>cmd_install_is_valid()</code> to construct functions returning boolean values testing for an install path. These are useful in function logic, or package development for setting conditional examples or function hooks that depend on a command install. <code>cmd_install_is_valid()</code> takes a path search function as input, so any <code>options</code>, <code>.Renviron</code>, or default install location logic propagates to these functions as well.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">meme_installed &lt;-<span class="st"> </span><span class="kw">cmd_install_is_valid</span>(search_meme_path)</a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="kw">meme_installed</span>()</a>
<a class="sourceLine" id="cb32-3" data-line-number="3"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
<p>This also works on utils defined during path search construction.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">ame_installed &lt;-<span class="st"> </span><span class="kw">cmd_install_is_valid</span>(search_meme_path, <span class="dt">util =</span> <span class="st">&quot;ame&quot;</span>)</a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="kw">ame_installed</span>()</a>
<a class="sourceLine" id="cb33-3" data-line-number="3"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
</div>
</div>
<div id="bringing-it-all-together" class="section level2">
<h2>Bringing it all together</h2>
<p>Using a <code>cmd_args_</code> family function to get and convert function arguments to commandline flags. The path search function returns the correct <code>command</code> call which can be passed to <code>system2</code> or <code>processx</code> along with the flags generated from <code>cmd_list_to_flags</code>.</p>
<p>This makes for a robust shell wrapper without excess overhead.</p>
<p>In the <code>runDreme</code> function below, the user can pass any valid <code>dreme</code> argument using the rules for command args defined above to <code>...</code>. Allowing <code>meme_path</code> as a function argument and passing it to <code>search_meme_path</code> allows the user to override the default search path which is: the <code>MEME_PATH</code> environment variable, followed by the <code>~/meme/bin</code> default install.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">search_meme_path &lt;-<span class="st"> </span><span class="kw">cmd_path_search</span>(<span class="dt">environment_var =</span> <span class="st">&quot;MEME_PATH&quot;</span>,</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">                                       <span class="dt">default_path =</span> <span class="st">&quot;~/meme/bin&quot;</span>,</a>
<a class="sourceLine" id="cb34-3" data-line-number="3">                                       <span class="dt">utils =</span> <span class="kw">c</span>(<span class="st">&quot;dreme&quot;</span>, <span class="st">&quot;ame&quot;</span>))</a>
<a class="sourceLine" id="cb34-4" data-line-number="4"></a>
<a class="sourceLine" id="cb34-5" data-line-number="5">runDreme &lt;-<span class="st"> </span><span class="cf">function</span>(..., <span class="dt">meme_path =</span> <span class="ot">NULL</span>){</a>
<a class="sourceLine" id="cb34-6" data-line-number="6">  flags &lt;-<span class="st"> </span><span class="kw">cmd_args_dots</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-7" data-line-number="7"><span class="st">    </span><span class="kw">cmd_list_interp</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-8" data-line-number="8"><span class="st">    </span><span class="kw">cmd_list_to_flags</span>()</a>
<a class="sourceLine" id="cb34-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb34-10" data-line-number="10">  dreme_path &lt;-<span class="st"> </span><span class="kw">search_meme_path</span>(<span class="dt">path =</span> meme_path, <span class="dt">util =</span> <span class="st">&quot;dreme&quot;</span>)</a>
<a class="sourceLine" id="cb34-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb34-12" data-line-number="12">  <span class="kw">system2</span>(dreme_path, flags)</a>
<a class="sourceLine" id="cb34-13" data-line-number="13">}</a></code></pre></div>
<p>Commands can now run through <code>runDreme</code> by passing flags as function arguments.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw">runDreme</span>(<span class="dt">version =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>#&gt; 5.1.1</code></pre>
<p>If users have issues with the install, they can run <code>check_meme_install()</code> to verify the tools are being detected by R.</p>
</div>
<div id="additional-features" class="section level1">
<h1>Additional Features</h1>
<div id="restrict-argument-matching" class="section level2">
<h2>Restrict argument matching</h2>
<p>each <code>cmd_args_</code> family function accepts a character vector of names to <code>keep</code> or <code>drop</code> arguments which will restrict command argument matches to values in <code>keep</code> (or ignore those in <code>drop</code>). As of now, <code>keep</code> and <code>drop</code> are mutually exclusive.</p>
<p>This can be useful to allow only some function arguments to be captured as flags, while others can be used for function logic.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">myFunction &lt;-<span class="st"> </span><span class="cf">function</span>(arg1, arg2, <span class="dt">someText =</span> <span class="st">&quot;default&quot;</span>){</a>
<a class="sourceLine" id="cb37-2" data-line-number="2">  flags &lt;-<span class="st"> </span><span class="kw">cmd_args_named</span>(<span class="dt">keep =</span> <span class="kw">c</span>(<span class="st">&quot;arg1&quot;</span>, <span class="st">&quot;arg2&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-3" data-line-number="3"><span class="st">    </span><span class="kw">cmd_list_interp</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-4" data-line-number="4"><span class="st">    </span><span class="kw">cmd_list_to_flags</span>()</a>
<a class="sourceLine" id="cb37-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb37-6" data-line-number="6">  <span class="kw">print</span>(someText)</a>
<a class="sourceLine" id="cb37-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb37-8" data-line-number="8">  <span class="kw">return</span>(flags)</a>
<a class="sourceLine" id="cb37-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb37-10" data-line-number="10"></a>
<a class="sourceLine" id="cb37-11" data-line-number="11"><span class="kw">myFunction</span>(<span class="dt">arg1 =</span> <span class="st">&quot;blah&quot;</span>, <span class="dt">arg2 =</span> <span class="st">&quot;blah&quot;</span>)</a>
<a class="sourceLine" id="cb37-12" data-line-number="12"><span class="co">#&gt; [1] &quot;default&quot;</span></a>
<a class="sourceLine" id="cb37-13" data-line-number="13"><span class="co">#&gt; [1] &quot;-arg1&quot; &quot;blah&quot;  &quot;-arg2&quot; &quot;blah&quot;</span></a></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="kw">myFunction</span>(<span class="dt">arg1 =</span> <span class="st">&quot;blah&quot;</span>, <span class="dt">arg2 =</span> <span class="st">&quot;blah&quot;</span>, <span class="dt">someText =</span> <span class="st">&quot;hello world&quot;</span>)</a>
<a class="sourceLine" id="cb38-2" data-line-number="2"><span class="co">#&gt; [1] &quot;hello world&quot;</span></a>
<a class="sourceLine" id="cb38-3" data-line-number="3"><span class="co">#&gt; [1] &quot;-arg1&quot; &quot;blah&quot;  &quot;-arg2&quot; &quot;blah&quot;</span></a></code></pre></div>
</div>
<div id="manipulating-list-objects" class="section level2">
<h2>Manipulating list objects</h2>
<p>For the most part, the <a href="https://purrr.tidyverse.org/">purrr</a> library is the most useful toolkit for operations on list objects.</p>
<p><code>cmdfun</code> provides additional helper functions to handle common manipulations.</p>
<p><code>cmd_list_drop</code> operates on argument &amp; flag lists to drop all entries corresponding to a certain name, specific name/value pairs, or by index position. Conversely, <code>cmd_list_keep</code> functions identically but for keeping entries.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">myList &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">'value1'</span> =<span class="st"> </span><span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb39-2" data-line-number="2">               <span class="st">'value2'</span> =<span class="st"> &quot;Hello&quot;</span>,</a>
<a class="sourceLine" id="cb39-3" data-line-number="3">               <span class="st">'value2'</span> =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb39-4" data-line-number="4"></a>
<a class="sourceLine" id="cb39-5" data-line-number="5"><span class="kw">cmd_list_keep</span>(myList, <span class="st">&quot;value2&quot;</span>)</a>
<a class="sourceLine" id="cb39-6" data-line-number="6"><span class="co">#&gt; $value2</span></a>
<a class="sourceLine" id="cb39-7" data-line-number="7"><span class="co">#&gt; [1] &quot;Hello&quot;</span></a>
<a class="sourceLine" id="cb39-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb39-9" data-line-number="9"><span class="co">#&gt; $value2</span></a>
<a class="sourceLine" id="cb39-10" data-line-number="10"><span class="co">#&gt; [1] 1 2 3 4</span></a></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="kw">cmd_list_keep</span>(myList, <span class="kw">c</span>(<span class="st">&quot;value2&quot;</span> =<span class="st"> &quot;Hello&quot;</span>))</a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="co">#&gt; $value2</span></a>
<a class="sourceLine" id="cb40-3" data-line-number="3"><span class="co">#&gt; [1] &quot;Hello&quot;</span></a></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="kw">cmd_list_drop</span>(myList, <span class="st">&quot;value2&quot;</span>)</a>
<a class="sourceLine" id="cb41-2" data-line-number="2"><span class="co">#&gt; $value1</span></a>
<a class="sourceLine" id="cb41-3" data-line-number="3"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
<p>These functions can be useful for ignoring setting certain flags if the user set them to a specific value.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">myFunction &lt;-<span class="st"> </span><span class="cf">function</span>(arg1, arg2){</a>
<a class="sourceLine" id="cb42-2" data-line-number="2">  flags &lt;-<span class="st"> </span><span class="kw">cmd_args_named</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb42-3" data-line-number="3"><span class="st">    </span><span class="kw">cmd_list_interp</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb42-4" data-line-number="4"><span class="st">    </span><span class="co"># if arg2 == &quot;baz&quot;, don't include it </span></a>
<a class="sourceLine" id="cb42-5" data-line-number="5"><span class="st">    </span><span class="kw">cmd_list_drop</span>(<span class="kw">c</span>(<span class="st">&quot;arg2&quot;</span> =<span class="st"> &quot;baz&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb42-6" data-line-number="6"><span class="st">    </span><span class="kw">cmd_list_to_flags</span>()</a>
<a class="sourceLine" id="cb42-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb42-8" data-line-number="8">  <span class="kw">return</span>(flags)</a>
<a class="sourceLine" id="cb42-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb42-10" data-line-number="10"></a>
<a class="sourceLine" id="cb42-11" data-line-number="11"><span class="kw">myFunction</span>(<span class="dt">arg1 =</span> <span class="st">&quot;foo&quot;</span>, <span class="dt">arg2 =</span> <span class="st">&quot;bar&quot;</span>)</a>
<a class="sourceLine" id="cb42-12" data-line-number="12"><span class="co">#&gt; [1] &quot;-arg1&quot; &quot;foo&quot;   &quot;-arg2&quot; &quot;bar&quot;</span></a>
<a class="sourceLine" id="cb42-13" data-line-number="13"><span class="kw">myFunction</span>(<span class="dt">arg1 =</span> <span class="st">&quot;foo&quot;</span>, <span class="dt">arg2 =</span> <span class="st">&quot;baz&quot;</span>)</a>
<a class="sourceLine" id="cb42-14" data-line-number="14"><span class="co">#&gt; [1] &quot;-arg1&quot; &quot;foo&quot;</span></a></code></pre></div>
</div>
<div id="expecting-output-files" class="section level2">
<h2>Expecting output files</h2>
<p>Sometimes a commandline function returns multiple output files you want to check for after the run.</p>
<p><code>cmd_error_if_missing</code> accepts a vector or list of files &amp; checks that they exist.</p>
<p><code>cmdfun</code> additionally provides a few convenience functions for generating lists of expected files. <code>cmd_file_combn</code> generates combinations of extension/prefix file names. The output can be passed to <code>cmd_error_if_missing</code> which will error if a file isn’t found on the filesystem.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="kw">cmd_file_combn</span>(<span class="dt">ext =</span> <span class="kw">c</span>(<span class="st">&quot;txt&quot;</span>, <span class="st">&quot;xml&quot;</span>), <span class="dt">prefix =</span> <span class="st">&quot;outFile&quot;</span>)</a>
<a class="sourceLine" id="cb43-2" data-line-number="2"><span class="co">#&gt; $txt</span></a>
<a class="sourceLine" id="cb43-3" data-line-number="3"><span class="co">#&gt; [1] &quot;./outFile.txt&quot;</span></a>
<a class="sourceLine" id="cb43-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb43-5" data-line-number="5"><span class="co">#&gt; $xml</span></a>
<a class="sourceLine" id="cb43-6" data-line-number="6"><span class="co">#&gt; [1] &quot;./outFile.xml&quot;</span></a></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="kw">cmd_file_combn</span>(<span class="dt">ext =</span> <span class="st">&quot;txt&quot;</span>, <span class="dt">prefix =</span> <span class="kw">c</span>(<span class="st">&quot;outFile&quot;</span>, <span class="st">&quot;outFile2&quot;</span>, <span class="st">&quot;outFile3&quot;</span>))</a>
<a class="sourceLine" id="cb44-2" data-line-number="2"><span class="co">#&gt; $outFile</span></a>
<a class="sourceLine" id="cb44-3" data-line-number="3"><span class="co">#&gt; [1] &quot;./outFile.txt&quot;</span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb44-5" data-line-number="5"><span class="co">#&gt; $outFile2</span></a>
<a class="sourceLine" id="cb44-6" data-line-number="6"><span class="co">#&gt; [1] &quot;./outFile2.txt&quot;</span></a>
<a class="sourceLine" id="cb44-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb44-8" data-line-number="8"><span class="co">#&gt; $outFile3</span></a>
<a class="sourceLine" id="cb44-9" data-line-number="9"><span class="co">#&gt; [1] &quot;./outFile3.txt&quot;</span></a></code></pre></div>
<p>Alternately, <code>cmd_file_expect</code> will build a list of expected files and check whether they exist. This is a wrapper around <code>cmd_file_combn %&gt;% cmd_error_if_missing</code>.</p>
</div>
<div id="error-checking-user-input" class="section level2">
<h2>Error checking user input</h2>
<p>When using <code>cmdfun</code> to write lazy shell wrappers, the user can easily mistype a commandline flag since there is not text completion. Some programs behave unexpectedly when flags are typed incorrectly, and for this reason return uninformative error messages. <code>cmdfun</code> has built-in methods to automatically populate a list of valid flags from a command’s help-text.</p>
<p>Alternatively, package builders could pass a vector of allowed flag names to check against if they didn’t want to parse help text. The goal is maximum flexibility.</p>
<p>The following example demonstrates how to parse help text (in this case from <code>tar</code>) into a vector of allowed flags. This vector is compared to the user-input flags (<code>user_input_flags</code> below), and tries to identify misspelled function arguments.</p>
<p>Here, the user has accidentally used the argument <code>delte</code> instead of <code>delete</code>. <code>cmdfun</code> tries to be helpful and identify the misspelling for the user.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1">user_input_flags &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;delte&quot;</span>)</a>
<a class="sourceLine" id="cb45-2" data-line-number="2"></a>
<a class="sourceLine" id="cb45-3" data-line-number="3"><span class="kw">system2</span>(<span class="st">&quot;tar&quot;</span>, <span class="st">&quot;--help&quot;</span>, <span class="dt">stdout =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-4" data-line-number="4"><span class="st">  </span><span class="kw">cmd_help_parse_flags</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-5" data-line-number="5"><span class="st">  </span><span class="co"># Compares User-input flags to parsed commandline flags</span></a>
<a class="sourceLine" id="cb45-6" data-line-number="6"><span class="st">  </span><span class="co"># returns flags that match based on edit distance</span></a>
<a class="sourceLine" id="cb45-7" data-line-number="7"><span class="st">  </span><span class="kw">cmd_help_flags_similar</span>(user_input_flags) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-8" data-line-number="8"><span class="st">  </span><span class="co"># Prints error message suggesting the most similar flag name</span></a>
<a class="sourceLine" id="cb45-9" data-line-number="9"><span class="st">  </span><span class="kw">cmd_help_flags_suggest</span>()</a>
<a class="sourceLine" id="cb45-10" data-line-number="10"><span class="co">#&gt; Error: Invalid flags. Did you mean:</span></a>
<a class="sourceLine" id="cb45-11" data-line-number="11"><span class="co">#&gt; &quot;delete&quot; instead of: &quot;delte&quot;</span></a></code></pre></div>
</div>
<div id="unsafe-operations" class="section level2">
<h2>Unsafe operations</h2>
<p><strong>WARNING:</strong> It’s still possible to do unsafe operations as follows, so please be careful how you build system calls.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1">shellCut_unsafe &lt;-<span class="st"> </span><span class="cf">function</span>(text, ...){</a>
<a class="sourceLine" id="cb46-2" data-line-number="2"></a>
<a class="sourceLine" id="cb46-3" data-line-number="3">  flags &lt;-<span class="st"> </span><span class="kw">cmd_args_dots</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-4" data-line-number="4"><span class="st">    </span><span class="kw">cmd_list_interp</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb46-5" data-line-number="5"><span class="st">    </span><span class="kw">cmd_list_to_flags</span>()</a>
<a class="sourceLine" id="cb46-6" data-line-number="6"></a>
<a class="sourceLine" id="cb46-7" data-line-number="7">    <span class="kw">system2</span>(<span class="st">&quot;echo&quot;</span>, <span class="kw">c</span>(text , <span class="st">&quot;|&quot;</span>, <span class="st">&quot;cut&quot;</span>, flags), <span class="dt">stdout =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb46-8" data-line-number="8"></a>
<a class="sourceLine" id="cb46-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb46-10" data-line-number="10"></a>
<a class="sourceLine" id="cb46-11" data-line-number="11"><span class="kw">shellCut_unsafe</span>(<span class="st">&quot;hello_world&quot;</span>, <span class="dt">f =</span> <span class="dv">2</span>, <span class="dt">d =</span> <span class="st">&quot;_ &amp;&amp; echo unsafe operation!&quot;</span>)</a>
<a class="sourceLine" id="cb46-12" data-line-number="12"><span class="co">#&gt; [1] &quot;world&quot;             &quot;unsafe operation!&quot;</span></a></code></pre></div>
<p><strong>NOTE</strong> even if when setting <code>stdout = TRUE</code> the second command doesn’t appear in the output, it will still have run.</p>
<p>A more extreme example of what can happen is here, where <code>~/deleteme.txt</code> will be removed silently.</p>
<p>I promise I’ll get around to sanitizing user input eventually, I am still reasoning about the best way to do this. You can provide feedback on this process at <a href="https://github.com/snystrom/cmdfun/issues/6">this issue</a>.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" data-line-number="1"><span class="kw">shellCut</span>(<span class="st">&quot;hello_world&quot;</span>, <span class="dt">f =</span> <span class="dv">2</span>, <span class="dt">d =</span> <span class="st">&quot;_ &amp;&amp; rm ~/deleteme.txt&quot;</span>)</a></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
